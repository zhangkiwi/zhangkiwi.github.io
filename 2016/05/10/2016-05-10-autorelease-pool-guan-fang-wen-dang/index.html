<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>autorelease pool 官方文档 | Kiwi</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">autorelease pool 官方文档</h1><a id="logo" href="/.">Kiwi</a><p class="description">志存高远，脚踏实地</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> Inicio</i></a><a href="/archives/"><i class="fa fa-archive"> Archivo</i></a><a href="/about/"><i class="fa fa-user"> Acerca de</i></a><a href="/atom.xml"><i class="fa fa-rss"> RSS</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">autorelease pool 官方文档</h1><div class="post-meta">May 10, 2016<span> | </span><span class="category"><a href="/categories/Objective-C/">Objective-C</a></span></div><div class="post-content"><h1 id="使用Autorelease-Pool"><a href="#使用Autorelease-Pool" class="headerlink" title="使用Autorelease Pool"></a>使用Autorelease Pool</h1><p>自动释放池提供了一种可以释放对象所有权的机制，并且能够避免提前释放对象（就像你从方法里面返回对象）。通常我们不需要创建自动释放池，但是有些情况我们必须这么做或者最好创建一个自动释放池。<br><a id="more"></a></p>
<h2 id="关于自动释放池"><a href="#关于自动释放池" class="headerlink" title="关于自动释放池"></a>关于自动释放池</h2><p>一个自动释放池用 @autoreleasepool 标记，就像下面的例子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">@autoreleasepool</span> <span class="string">&#123;</span></span><br><span class="line">   <span class="string">//</span> <span class="string">Code</span> <span class="string">that</span> <span class="string">creates</span> <span class="string">autoreleased</span> <span class="string">objects.</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在这个自动释放池的最后对象会接收一个 autorelease 消息，然后发送一个release 消息。</p>
<p>像其他代码块一样，自动释放池也可以嵌套使用：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">@autoreleasepool</span> <span class="string">&#123;</span></span><br><span class="line">   <span class="string">//</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line">      <span class="string">@autoreleasepool</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">//</span> <span class="string">.</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line">       <span class="string">&#125;</span></span><br><span class="line">   	<span class="string">.</span> <span class="string">.</span> <span class="string">.</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>AppKit 和 UIKit 库在自动释放池的每次事件循环迭代（ event-loop iteration ）过程中， Cocoa 总是会预测你的代码在自动释放池的执行情况，否则你的对象就不会被释放，并且造成内存泄露。（如果你在自动释放池的外面向对象发送 autorelease 消息，Cocoa 将会打印出相应的错误信息）。通常我们都不需要创建自动释放池，有几种情况还是要我们自己创建自动释放池：</p>
<p>1.如果写的程序不是基于UI framework的，就像是命令行工具。</p>
<p>2.如果写的程序有大量的临时对象。</p>
<p> 我们可能就需要创建一个自动释放池来处理掉对象，在进行下一次循环迭代的时候。在循环里面创建一个自动释放池可以帮助我们减少最大内存峰值。</p>
<p>3.如果我们创建了子线程的时候。</p>
<p> 在子线程开始的时候，我们必须创建一个自动释放池，不然我们的应用就会有内存泄露。</p>
<h2 id="使用自动释放池减少内存峰值"><a href="#使用自动释放池减少内存峰值" class="headerlink" title="使用自动释放池减少内存峰值"></a>使用自动释放池减少内存峰值</h2><p>很多程序创建临时对象会被加到内存中然后在最后被自动释放，在许多情况下，允许临时对象在内存中积累直到当前事件循环结束并不会造成过度开销，然而，在一些情况下，你创建了大量的临时对象放在内存中，并且想快速的处理掉，在后一种情况我们就可以创建一个自动释放池，在自动释放池结束的时候，临时对象就会被释放掉，从而减少内存。<br>下面的例子展示了我们在 for 循环中使用自动释放池：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">NSArray</span> <span class="meta">*urls</span> <span class="string">=</span> <span class="string">&lt;#</span> <span class="string">An</span> <span class="string">array</span> <span class="string">of</span> <span class="string">file</span> <span class="string">URLs</span> <span class="comment">#&gt;;</span></span><br><span class="line"><span class="string">for</span> <span class="string">(NSURL</span> <span class="meta">*url</span> <span class="string">in</span> <span class="string">urls)</span> <span class="string">&#123;</span></span><br><span class="line"></span><br><span class="line">   <span class="string">@autoreleasepool</span> <span class="string">&#123;</span></span><br><span class="line">       <span class="string">NSError</span> <span class="string">*error;</span></span><br><span class="line">       <span class="string">NSString</span> <span class="meta">*fileContents</span> <span class="string">=</span> <span class="string">[NSString</span> <span class="attr">stringWithContentsOfURL:url</span></span><br><span class="line"><span class="attr">                                        encoding:</span><span class="string">NSUTF8StringEncoding</span> <span class="attr">error:&amp;error];</span></span><br><span class="line">       <span class="string">/*</span> <span class="string">Process</span> <span class="string">the</span> <span class="string">string,</span> <span class="string">creating</span> <span class="string">and</span> <span class="string">autoreleasing</span> <span class="string">more</span> <span class="string">objects.</span> <span class="string">*/</span></span><br><span class="line">   <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在每次 for 循环的时候，一个对象（如 fileContents）在自动释放池里面发送一个 autorelease 消息然后在结束的时候被释放掉。</p>
<p>下面一个自动释放池你需要注意任何对象在自动释放池内已经被释放掉了，你就不能发送消息给这个对象，或者用它来调用方法。如果你必须在自动释放池外使用临时对象，你可以在自动释放池内先给他发送一个 retain 消息，然后再自动释放池外给它发送一个 autorelease 消息，下面这个例子进行了说明：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">–</span> <span class="string">(id)findMatchingObject:(id)anObject</span> <span class="string">&#123;</span></span><br><span class="line"></span><br><span class="line">   <span class="string">id</span> <span class="string">match;</span></span><br><span class="line">   <span class="string">while</span> <span class="string">(match</span> <span class="string">==</span> <span class="string">nil)</span> <span class="string">&#123;</span></span><br><span class="line">       <span class="string">@autoreleasepool</span> <span class="string">&#123;</span></span><br><span class="line"></span><br><span class="line">           <span class="string">/*</span> <span class="string">Do</span> <span class="string">a</span> <span class="string">search</span> <span class="string">that</span> <span class="string">creates</span> <span class="string">a</span> <span class="string">lot</span> <span class="string">of</span> <span class="string">temporary</span> <span class="string">objects.</span> <span class="string">*/</span></span><br><span class="line">           <span class="string">match</span> <span class="string">=</span> <span class="string">[self</span> <span class="attr">expensiveSearchForObject:anObject];</span></span><br><span class="line"></span><br><span class="line">           <span class="string">if</span> <span class="string">(match</span> <span class="string">!=</span> <span class="string">nil)</span> <span class="string">&#123;</span></span><br><span class="line">               <span class="string">[match</span> <span class="string">retain];</span> <span class="string">/*</span> <span class="string">Keep</span> <span class="string">match</span> <span class="string">around.</span> <span class="string">*/</span></span><br><span class="line">           <span class="string">&#125;</span></span><br><span class="line">       <span class="string">&#125;</span></span><br><span class="line">   <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line">   <span class="string">return</span> <span class="string">[match</span> <span class="string">autorelease];</span>   <span class="string">/*</span> <span class="string">Let</span> <span class="string">match</span> <span class="string">go</span> <span class="string">and</span> <span class="string">return</span> <span class="string">it.</span> <span class="string">*/</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="自动释放池和线程"><a href="#自动释放池和线程" class="headerlink" title="自动释放池和线程"></a>自动释放池和线程</h2><p>在 Cocoa 应用程序中每个线程都会有一个自动释放池，如果你创建了一个线程，或者只用了基础框架进行编程。那样你就需要创建一个自动释放池。<br>如果你的程序或者线程长时间的生成潜在释放对象，那就应该使用自动释放池，如果你的子线程没有调用 Cocoa 方法，那就可以不使用自动释放池。</p>
<h2 id="以上为对官方文档的翻译"><a href="#以上为对官方文档的翻译" class="headerlink" title="以上为对官方文档的翻译"></a>以上为对官方文档的翻译</h2><h2 id="以下为对相关博客的引用"><a href="#以下为对相关博客的引用" class="headerlink" title="以下为对相关博客的引用"></a>以下为对相关博客的引用</h2><h3 id="Autorelease-Pool-进行-Drain-的时机"><a href="#Autorelease-Pool-进行-Drain-的时机" class="headerlink" title="Autorelease Pool 进行 Drain 的时机"></a>Autorelease Pool 进行 Drain 的时机</h3><p>如上面所说，系统在 runloop 中创建的 autoreleaspool 会在 runloop 一个 event 结束时进行释放操作。我们手动创建的 autoreleasepool 会在 block 执行完成之后进行 drain 操作。需要注意的是：</p>
<p>1.当 block 以异常（exception）结束时，pool 不会被 drain</p>
<p>2.Pool 的 drain 操作会把所有标记为 autorelease 的对象的引用计数减一，但是并不意味着这个对象一定会被释放掉，我们可以在 autorelease pool 中手动 retain 对象，以延长它的生命周期（在 MRC 中）。</p>
<h3 id="Autorelease-Pool-与函数返回值"><a href="#Autorelease-Pool-与函数返回值" class="headerlink" title="Autorelease Pool 与函数返回值"></a>Autorelease Pool 与函数返回值</h3><p>如果一个函数的返回值是指向一个对象的指针，那么这个对象肯定不能在函数返回之前进行 release，这样调用者在调用这个函数时得到的就是野指针了，在函数返回之后也不能立刻就 release，因为我们不知道调用者是不是 retain 了这个对象，如果我们直接 release 了，可能导致后面在使用这个对象时它已经成为 nil 了。</p>
<p>为了解决这个纠结的问题， Objective-C 中对对象指针的返回值进行了区分，一种叫做 retained return value，另一种叫做 unretained return value。前者表示调用者拥有这个返回值，后者表示调用者不拥有这个返回值，按照“谁拥有谁释放”的原则，对于前者调用者是要负责释放的，对于后者就不需要了。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/MemoryMgmt/Articles/mmAutoreleasePools.html#//apple_ref/doc/uid/20000047-CJBFBEDI" target="_blank" rel="noopener">Using Autorelease Pool Blocks</a></li>
<li><a href="https://segmentfault.com/a/1190000004943276?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="noopener">Objective-C 内存管理——你需要知道的一切</a></li>
<li><a href="http://blog.leichunfeng.com/blog/2015/05/31/objective-c-autorelease-pool-implementation-principle/" target="_blank" rel="noopener">Objective-C Autorelease Pool 的实现原理</a></li>
</ul>
</div><div class="tags"><a href="/tags/内存/">内存</a></div><div class="post-nav"><a class="pre" href="/2016/05/17/2016-05-17-duo-xian-cheng-nsoperation/">多线程之NSOperation</a><a class="next" href="/2016/05/08/2016-05-08-instrumentsgong-ju-shi-yong/">instruments工具使用</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> Categorías</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Objective-C/">Objective-C</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Xcode/">Xcode</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> Etiquetas</i></div><div class="tagcloud"><a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/内存/" style="font-size: 15px;">内存</a> <a href="/tags/block/" style="font-size: 15px;">block</a> <a href="/tags/Runtime/" style="font-size: 15px;">Runtime</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> Recientes</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/08/05/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/24/2016-06-24/">property属性</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/20/2016-06-20-runtimezhi-guan-lian-dui-xiang/">Runtime之关联对象</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/13/2016-06-13-runtime/">Runtime基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/06/07/2016-06-07-shenkaobei/">深拷贝与浅拷贝</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/26/2016-05-26-block/">Block使用与注意</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/24/2016-05-24-duo-xian-cheng-zhi-gcd-er/">多线程之GCD(二)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/19/2016-05-19-at-duo-xian-cheng-zhi-gcd/">多线程之GCD（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/17/2016-05-17-duo-xian-cheng-nsoperation/">多线程之NSOperation</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/05/10/2016-05-10-autorelease-pool-guan-fang-wen-dang/">autorelease pool 官方文档</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> Blogroll</i></div><ul></ul><a href="http://southpeak.github.io/" title="南峰子的技术博客" target="_blank">南峰子的技术博客</a><ul></ul><a href="http://www.leichunfeng.com/blog/archives/" title="雷纯锋的技术博客" target="_blank">雷纯锋的技术博客</a><ul></ul><a href="http://www.iosxxx.com/archives/" title="向晨宇的技术博客" target="_blank">向晨宇的技术博客</a><ul></ul><a href="http://allluckly.cn/tags/index.html#%E7%A8%8B%E5%BA%8F%E5%91%98%EF%BC%8C%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93%EF%BC%8C%E7%A0%81%E5%86%9C%E4%BA%BA%E7%94%9F%EF%BC%8CiOS%E5%BC%80%E5%8F%91" title="iOS开发" target="_blank">iOS开发</a><ul></ul><a href="https://draveness.me/index" title="面向信仰编程" target="_blank">面向信仰编程</a><ul></ul><a href="http://www.beyondabel.com/blog/archives/" title="Abel's Den" target="_blank">Abel's Den</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">Kiwi.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>